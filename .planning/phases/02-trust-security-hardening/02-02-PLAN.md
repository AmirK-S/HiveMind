---
phase: 02-trust-security-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - hivemind/db/models.py
  - hivemind/config.py
  - alembic/versions/003_api_keys.py
  - alembic/versions/004_auto_approve_rules.py
  - alembic/versions/005_webhook_endpoints.py
autonomous: true
requirements: [TRUST-04, INFRA-04, INFRA-03, SEC-03]

must_haves:
  truths:
    - "ApiKey model exists with key_prefix, key_hash, org_id, agent_id, tier, request_count, billing_period fields"
    - "AutoApproveRule model exists with org_id, category, is_auto_approve and unique constraint on (org_id, category)"
    - "WebhookEndpoint model exists with org_id, url, is_active, event_types"
    - "Settings has redis_url, burst_threshold, burst_window_seconds fields"
    - "Alembic migrations 003, 004, 005 exist and create the corresponding tables"
  artifacts:
    - path: "hivemind/db/models.py"
      provides: "ApiKey, AutoApproveRule, WebhookEndpoint ORM models"
      contains: "class ApiKey"
    - path: "hivemind/config.py"
      provides: "Phase 2 settings: redis_url, burst_*, falkordb_*"
      contains: "redis_url"
    - path: "alembic/versions/003_api_keys.py"
      provides: "Migration for api_keys table"
      contains: "api_keys"
    - path: "alembic/versions/004_auto_approve_rules.py"
      provides: "Migration for auto_approve_rules table"
      contains: "auto_approve_rules"
    - path: "alembic/versions/005_webhook_endpoints.py"
      provides: "Migration for webhook_endpoints table"
      contains: "webhook_endpoints"
  key_links:
    - from: "hivemind/db/models.py"
      to: "alembic/versions/003_api_keys.py"
      via: "model-to-migration correspondence"
      pattern: "class ApiKey.*api_keys"
    - from: "hivemind/config.py"
      to: "hivemind/db/models.py"
      via: "tier defaults referenced in model"
      pattern: "redis_url|burst_threshold"
---

<objective>
Create all new database models, Alembic migrations, and configuration settings needed by Phase 2 features.

Purpose: Establish the schema foundation so all subsequent Phase 2 plans can reference these models and settings without worrying about DB migrations.
Output: Three new ORM models (ApiKey, AutoApproveRule, WebhookEndpoint), three Alembic migrations, and extended Settings class.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-trust-security-hardening/02-RESEARCH.md
@hivemind/db/models.py
@hivemind/config.py
@alembic/versions/002_add_deleted_at.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new ORM models and extend config settings</name>
  <files>hivemind/db/models.py, hivemind/config.py</files>
  <action>
**In `hivemind/db/models.py`, add three new models after DeploymentConfig:**

1. `ApiKey` model (`__tablename__ = "api_keys"`):
   - `id: Mapped[uuid.UUID]` — UUID primary key with default uuid4
   - `key_prefix: Mapped[str]` — String(8), not null — first 8 chars for display/lookup
   - `key_hash: Mapped[str]` — String(64), not null, unique — SHA-256 of the full API key (never store raw key)
   - `org_id: Mapped[str]` — String(255), not null, indexed
   - `agent_id: Mapped[str]` — String(255), not null
   - `tier: Mapped[str]` — String(20), not null, default "free" — values: "free", "pro", "enterprise"
   - `request_count: Mapped[int]` — Integer, not null, default 0
   - `billing_period_start: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow
   - `billing_period_reset_days: Mapped[int]` — Integer, not null, default 30
   - `is_active: Mapped[bool]` — Boolean, not null, default True
   - `created_at: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow
   - `last_used_at: Mapped[datetime.datetime | None]` — DateTime(timezone=True), nullable
   - Add `Index("ix_api_keys_key_hash", "key_hash")` and `Index("ix_api_keys_org_id", "org_id")` in `__table_args__`
   - Add `Integer` to the SQLAlchemy imports at the top of the file

2. `AutoApproveRule` model (`__tablename__ = "auto_approve_rules"`):
   - `id: Mapped[uuid.UUID]` — UUID primary key with default uuid4
   - `org_id: Mapped[str]` — String(255), not null
   - `category: Mapped[KnowledgeCategory]` — Enum(KnowledgeCategory, name="knowledgecategory"), not null (reuse the existing enum type name)
   - `is_auto_approve: Mapped[bool]` — Boolean, not null, default False
   - `created_at: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow
   - `updated_at: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow, onupdate utcnow
   - Add `UniqueConstraint("org_id", "category", name="uq_auto_approve_rules_org_category")` in `__table_args__`

3. `WebhookEndpoint` model (`__tablename__ = "webhook_endpoints"`):
   - `id: Mapped[uuid.UUID]` — UUID primary key with default uuid4
   - `org_id: Mapped[str]` — String(255), not null, indexed
   - `url: Mapped[str]` — Text, not null — the webhook URL to POST to
   - `event_types: Mapped[dict | None]` — JSONB, nullable — list of event types to subscribe to (e.g. ["knowledge.approved", "knowledge.published"])
   - `is_active: Mapped[bool]` — Boolean, not null, default True
   - `created_at: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow
   - `updated_at: Mapped[datetime.datetime]` — DateTime(timezone=True), not null, default utcnow, onupdate utcnow

**In `hivemind/config.py`, add new settings to the Settings class:**

```python
# Redis (rate limiting, Celery broker)
redis_url: str = "redis://localhost:6379/0"

# Rate limiting / anti-sybil (SEC-03)
burst_threshold: int = 50
burst_window_seconds: int = 60

# FalkorDB (INFRA-02)
falkordb_host: str = "localhost"
falkordb_port: int = 6379
falkordb_database: str = "hivemind"

# Injection scanner (SEC-01)
injection_threshold: float = 0.5
```

Place these after the existing `max_search_limit` field in the Settings class.
  </action>
  <verify>
Run `python -c "from hivemind.db.models import ApiKey, AutoApproveRule, WebhookEndpoint; print('All models importable')"` — should succeed.
Run `python -c "from hivemind.config import settings; print(f'redis_url={settings.redis_url}, burst={settings.burst_threshold}')"` — should print defaults.
  </verify>
  <done>ApiKey, AutoApproveRule, and WebhookEndpoint ORM models are defined. Settings class has redis_url, burst_threshold, burst_window_seconds, falkordb_*, and injection_threshold fields with sensible defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Create Alembic migrations for new tables</name>
  <files>alembic/versions/003_api_keys.py, alembic/versions/004_auto_approve_rules.py, alembic/versions/005_webhook_endpoints.py</files>
  <action>
Create three manual Alembic migration files following the same pattern as existing 001/002 migrations. Each migration is a standalone file (manual, not autogenerated) with explicit DDL for clarity.

**003_api_keys.py:**
```python
"""Create api_keys table for API key authentication with tiers (INFRA-04)."""
revision = "003"
down_revision = "002"
```
- `upgrade()`: Create `api_keys` table with all columns matching the ApiKey model. Use `sa.Column`, `sa.UUID` (or `postgresql.UUID(as_uuid=True)`), proper types. Create indexes: `ix_api_keys_key_hash` on `key_hash`, `ix_api_keys_org_id` on `org_id`. Add unique constraint on `key_hash`.
- `downgrade()`: `op.drop_table("api_keys")`

**004_auto_approve_rules.py:**
```python
"""Create auto_approve_rules table for per-category auto-approval (TRUST-04)."""
revision = "004"
down_revision = "003"
```
- `upgrade()`: Create `auto_approve_rules` table. The `category` column should use the existing `knowledgecategory` enum type (already created by migration 001). Use `sa.Enum(name="knowledgecategory", create_type=False)` to reference it without creating a new type. Add `UniqueConstraint("org_id", "category", name="uq_auto_approve_rules_org_category")`.
- `downgrade()`: `op.drop_table("auto_approve_rules")`

**005_webhook_endpoints.py:**
```python
"""Create webhook_endpoints table for near-real-time push delivery (INFRA-03)."""
revision = "005"
down_revision = "004"
```
- `upgrade()`: Create `webhook_endpoints` table with all columns. Use JSONB for `event_types`. Add index on `org_id`.
- `downgrade()`: `op.drop_table("webhook_endpoints")`

NOTE: Do NOT create a migration for the `casbin_rule` table. Per research Pitfall 3, `casbin-async-sqlalchemy-adapter` creates this table automatically on first `load_policy()`. We'll stamp it in Plan 03.

All migrations follow the pattern from 001/002: import `from alembic import op` and `import sqlalchemy as sa`, use `sa.Column(...)` syntax, include `branch_labels = None` and `depends_on = None`.
  </action>
  <verify>
Run `python -c "
import importlib.util
for f in ['003_api_keys', '004_auto_approve_rules', '005_webhook_endpoints']:
    spec = importlib.util.spec_from_file_location(f, f'alembic/versions/{f}.py')
    mod = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(mod)
    assert hasattr(mod, 'upgrade'), f'{f} missing upgrade()'
    assert hasattr(mod, 'downgrade'), f'{f} missing downgrade()'
    print(f'{f}: OK')
"` — should print OK for all three.
  </verify>
  <done>Three Alembic migration files exist with correct revision chains (002 -> 003 -> 004 -> 005). Each creates the corresponding table with proper columns, indexes, and constraints. Downgrades drop the tables cleanly.</done>
</task>

</tasks>

<verification>
1. All three new models import cleanly from `hivemind.db.models`
2. Settings class has all new fields with defaults
3. Migration revision chain is intact: 001 -> 002 -> 003 -> 004 -> 005
4. Each migration has both upgrade() and downgrade() functions
</verification>

<success_criteria>
- ApiKey, AutoApproveRule, WebhookEndpoint models are defined in models.py with correct columns and constraints
- Three Alembic migrations exist with proper revision chain
- Config has redis_url, burst_*, falkordb_*, injection_threshold settings
- All new code is importable without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-trust-security-hardening/02-02-SUMMARY.md`
</output>
