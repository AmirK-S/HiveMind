---
phase: 01-agent-connection-loop
plan: 04
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
  - "01-03"
files_modified:
  - hivemind/server/tools/list_knowledge.py
  - hivemind/server/tools/delete_knowledge.py
  - hivemind/server/main.py
  - hivemind/cli/__init__.py
  - hivemind/cli/review.py
  - hivemind/cli/client.py
autonomous: true
requirements:
  - MCP-04
  - MCP-05
  - TRUST-02
  - TRUST-03

must_haves:
  truths:
    - "An agent calling list_knowledge sees only their own contributions (pending + approved) within their org namespace"
    - "An agent calling delete_knowledge can remove their own approved knowledge items, and deletion returns 404 (not 403) for items in other orgs"
    - "Deletion of a knowledge item cascades to derived artifacts (soft-delete flag set, not hard delete)"
    - "A user running 'hivemind review' sees pending contributions with PII already stripped, presented cleanly"
    - "A user can approve a contribution (private namespace, public commons, or both) and it moves to knowledge_items with embedding generated"
    - "A user can reject a contribution and it is removed from the pending queue"
    - "A user can override the agent-suggested category during approval"
    - "A user can flag a contribution as sensitive if PII stripping missed something"
    - "Approval shows gamification: contribution count and 'You've helped X agents' style message"
  artifacts:
    - path: "hivemind/server/tools/list_knowledge.py"
      provides: "list_knowledge MCP tool: paginated list of agent's contributions"
      contains: "list_knowledge"
      min_lines: 40
    - path: "hivemind/server/tools/delete_knowledge.py"
      provides: "delete_knowledge MCP tool: soft-delete with cascade"
      contains: "delete_knowledge"
      min_lines: 30
    - path: "hivemind/cli/review.py"
      provides: "CLI approval workflow with Typer + Rich + questionary"
      contains: "def review"
      min_lines: 80
    - path: "hivemind/cli/client.py"
      provides: "Sync DB client for CLI (not async) to avoid event loop issues"
      contains: "def fetch_pending"
      min_lines: 30
  key_links:
    - from: "hivemind/server/tools/delete_knowledge.py"
      to: "hivemind/db/models.py"
      via: "KnowledgeItem soft-delete with org_id check"
      pattern: "org_id.*==.*auth.*org_id"
    - from: "hivemind/cli/review.py"
      to: "hivemind/cli/client.py"
      via: "fetch_pending, approve_contribution, reject_contribution"
      pattern: "fetch_pending|approve_contribution|reject_contribution"
    - from: "hivemind/cli/review.py"
      to: "hivemind/pipeline/embedder.py"
      via: "Generates embedding on approval before inserting to knowledge_items"
      pattern: "get_embedder.*embed"
    - from: "hivemind/server/main.py"
      to: "hivemind/server/tools/list_knowledge.py"
      via: "Tool registration import"
      pattern: "list_knowledge"
    - from: "hivemind/server/main.py"
      to: "hivemind/server/tools/delete_knowledge.py"
      via: "Tool registration import"
      pattern: "delete_knowledge"
---

<objective>
Complete the MCP tool surface (list + delete) and build the CLI approval workflow. This closes the full contribute/approve/retrieve loop: agents contribute knowledge via MCP, users review and approve via CLI, approved knowledge becomes searchable.

Purpose: Without list/delete, agents cannot manage their contributions. Without the CLI review workflow, knowledge stays in quarantine forever. This plan completes the end-to-end Phase 1 loop.
Output: Two additional MCP tools (list_knowledge, delete_knowledge) registered on the server, and a `hivemind review` CLI command for approving/rejecting pending contributions with gamification.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-agent-connection-loop/01-RESEARCH.md
@.planning/phases/01-agent-connection-loop/01-01-SUMMARY.md
@.planning/phases/01-agent-connection-loop/01-02-SUMMARY.md
@.planning/phases/01-agent-connection-loop/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: list_knowledge and delete_knowledge MCP tools</name>
  <files>
    hivemind/server/tools/list_knowledge.py
    hivemind/server/tools/delete_knowledge.py
    hivemind/server/main.py
  </files>
  <action>
Create the remaining two MCP tools and replace the stubs in main.py:

**hivemind/server/tools/list_knowledge.py:**

`list_knowledge` MCP tool — agent sees their own contributions:

Parameters:
- `status: str = "all"` — filter: "pending", "approved", "all"
- `category: str | None = None` — filter by category
- `limit: int = 20` — max results
- `cursor: str | None = None` — pagination cursor (same base64 offset as search_knowledge)

Logic:
1. Extract auth context (org_id, agent_id) from bearer token
2. Build query based on status:
   - "pending": query `pending_contributions` WHERE `org_id = :org_id AND source_agent_id = :agent_id`
   - "approved": query `knowledge_items` WHERE `org_id = :org_id AND source_agent_id = :agent_id`
   - "all": UNION of both (or two separate queries merged in Python for simplicity)
3. Apply category filter if provided
4. Order by `contributed_at DESC` (most recent first)
5. Apply pagination
6. Return list with contribution details:
   ```python
   {
       "contributions": [
           {
               "id": str(item.id),
               "status": "pending" | "approved",
               "content_preview": item.content[:80] + "...",
               "category": item.category.value,
               "confidence": item.confidence,
               "contributed_at": item.contributed_at.isoformat(),
               "is_public": getattr(item, "is_public", None),  # only on approved items
           }
       ],
       "total_count": count,
       "next_cursor": cursor_or_none,
   }
   ```
- Agent can ONLY see their own contributions (filtered by source_agent_id from auth)

**hivemind/server/tools/delete_knowledge.py:**

`delete_knowledge` MCP tool — agent deletes their approved knowledge:

Parameters:
- `id: str` — UUID of the knowledge item to delete

Logic:
1. Extract auth context (org_id, agent_id) from bearer token
2. Query `knowledge_items` WHERE `id = :id AND org_id = :org_id AND source_agent_id = :agent_id`
   - CRITICAL: filter by org_id AND agent_id — agents can only delete their own items
   - Return 404 (not 403) if not found — don't reveal items exist in other orgs (per research pitfall 6)
3. Soft-delete: set `deleted_at` timestamp on the item (don't physically remove)
   - NOTE: This requires adding `deleted_at: DateTime | None` column to KnowledgeItem model. Add it in this task as a minor schema addition, and create a small Alembic migration `002_add_deleted_at.py`
4. All search queries must now filter `WHERE deleted_at IS NULL` — update search_knowledge query in this task
5. Return success:
   ```python
   {
       "id": id,
       "status": "deleted",
       "message": "Knowledge item deleted. It will no longer appear in search results."
   }
   ```

**hivemind/server/main.py updates:**
- Replace the stub imports for list_knowledge and delete_knowledge with real imports
- Ensure all 4 tools are registered on the MCP server

**Migration `alembic/versions/002_add_deleted_at.py`:**
- Add `deleted_at` column (nullable DateTime) to `knowledge_items` table
- Update KnowledgeItem model in models.py to include `deleted_at: Mapped[datetime.datetime | None]`
  </action>
  <verify>
Run `python -c "from hivemind.server.tools.list_knowledge import list_knowledge; print('list_knowledge OK')"`.
Run `python -c "from hivemind.server.tools.delete_knowledge import delete_knowledge; print('delete_knowledge OK')"`.
Verify main.py imports all 4 tool modules without the stub functions.
Verify KnowledgeItem model has `deleted_at` column.
  </verify>
  <done>list_knowledge shows agent's own contributions (pending + approved) with pagination. delete_knowledge soft-deletes owned items only, returns 404 for other-org items. Both tools extract auth from bearer token. search_knowledge updated to exclude soft-deleted items. Migration 002 adds deleted_at column.</done>
</task>

<task type="auto">
  <name>Task 2: CLI approval workflow with Typer + Rich + questionary</name>
  <files>
    hivemind/cli/__init__.py
    hivemind/cli/review.py
    hivemind/cli/client.py
  </files>
  <action>
Build the CLI approval experience per locked user decisions:

**hivemind/cli/__init__.py:**
- Create Typer app: `app = typer.Typer(name="hivemind", help="HiveMind CLI — manage your knowledge commons")`
- Import and register the review command

**hivemind/cli/client.py:**
- Synchronous database client for CLI operations (no asyncio event loop issues)
- Use `sqlalchemy.create_engine` (sync, NOT async) with a sync PostgreSQL URL (`postgresql://` not `postgresql+asyncpg://`)
  - Derive sync URL from settings.database_url by replacing `+asyncpg` with empty string
- `SessionFactory = sessionmaker(engine)`

Functions:
- `fetch_pending(org_id: str, limit: int = 10) -> list[PendingContribution]`:
  - Query pending_contributions WHERE org_id = :org_id, ordered by contributed_at ASC (oldest first)
  - Use `FOR UPDATE SKIP LOCKED` to prevent race conditions if multiple CLI sessions run (per research Pattern 6)
  - Note: FOR UPDATE SKIP LOCKED requires being inside a transaction; use session context manager
- `approve_contribution(contribution_id: UUID, is_public: bool = False, category_override: str | None = None) -> KnowledgeItem`:
  1. Fetch the PendingContribution by id
  2. Generate embedding: `embedding = get_embedder().embed(contribution.content)`
  3. Create KnowledgeItem from contribution data:
     - Copy: org_id, source_agent_id, run_id, content, content_hash, confidence, framework, language, version, tags, contributed_at
     - Set: category = category_override or contribution.category
     - Set: is_public = is_public param
     - Set: embedding = generated embedding
     - Set: approved_at = utcnow
  4. Delete the PendingContribution (it's been promoted)
  5. Return the new KnowledgeItem
- `reject_contribution(contribution_id: UUID) -> None`:
  - Delete the PendingContribution from the pending queue
- `flag_contribution(contribution_id: UUID) -> None`:
  - Set `is_sensitive_flagged = True` on the PendingContribution
- `get_org_stats(org_id: str) -> dict`:
  - Count total approved knowledge items for this org
  - Count distinct source_agent_id values across all orgs (to show "helped X agents")
  - Return `{"total_contributions": int, "agent_count": int}`

**hivemind/cli/review.py:**
- `@app.command() def review(org_id: str = typer.Option(..., envvar="HIVEMIND_ORG_ID"), limit: int = typer.Option(10, help="Max items to review")):`

Review loop per locked user decisions:
1. Fetch pending contributions via `client.fetch_pending(org_id, limit)`
2. If none pending:
   ```python
   console.print(Panel(
       "[green]All caught up! No pending contributions.[/green]",
       title="HiveMind",
       border_style="green"
   ))
   ```
   Return.

3. Show count header: `console.print(f"\n[bold]You have {len(pending)} contributions to review[/bold]\n")`

4. For each pending contribution, display with Rich Panel:
   ```python
   console.print(Panel(
       f"[bold]{item.category.value}[/bold] · "
       f"Confidence: {item.confidence}\n\n"
       f"{item.content}\n\n"
       f"[dim]Agent: {item.source_agent_id} · "
       f"{item.contributed_at.strftime('%Y-%m-%d %H:%M')}[/dim]"
       + (f"\n[dim]Framework: {item.framework}[/dim]" if item.framework else "")
       + (f" · [dim]Language: {item.language}[/dim]" if item.language else ""),
       title=f"Contribution {idx + 1}/{len(pending)}",
       border_style="blue"
   ))
   ```

5. Prompt action via questionary:
   ```python
   action = questionary.select(
       "What would you like to do?",
       choices=[
           "Approve (private)",
           "Approve (public commons)",
           "Change category & approve",
           "Flag as sensitive",
           "Reject",
           "Skip (review later)",
       ]
   ).ask()
   ```

6. Handle each action:
   - "Approve (private)": `approve_contribution(item.id, is_public=False)`
   - "Approve (public commons)": `approve_contribution(item.id, is_public=True)`
   - "Change category & approve":
     - Prompt category: `questionary.select("Choose category:", choices=[c.value for c in KnowledgeCategory]).ask()`
     - Then prompt visibility: `questionary.select("Visibility:", choices=["Private", "Public commons"]).ask()`
     - `approve_contribution(item.id, is_public=..., category_override=new_cat)`
   - "Flag as sensitive": `flag_contribution(item.id)` + print "[yellow]Flagged for review. This contribution will be re-examined.[/yellow]"
   - "Reject": `reject_contribution(item.id)` + print "[red]Rejected.[/red]"
   - "Skip": continue to next item

7. After each approval, show gamification message (per user decision: positive, rewarding):
   ```python
   stats = get_org_stats(org_id)
   console.print(
       f"[green]Approved! "
       f"Your org has shared {stats['total_contributions']} pieces of knowledge "
       f"helping {stats['agent_count']} agents learn faster.[/green]\n"
   )
   ```

8. After all items reviewed, show session summary:
   ```python
   console.print(Panel(
       f"[bold green]Review session complete![/bold green]\n\n"
       f"Approved: {approved_count}\n"
       f"Rejected: {rejected_count}\n"
       f"Flagged: {flagged_count}\n"
       f"Skipped: {skipped_count}",
       title="Session Summary",
       border_style="green"
   ))
   ```

IMPORTANT per user decisions:
- The feel is POSITIVE and REWARDING — no scary PII warnings, just clean content
- Users only see the CLEAN (already PII-stripped) version — no before/after comparison
- Light gamification with contribution count and "helped X agents" messaging
- Category override is available during approval
- "Flag as sensitive" is available if PII stripping missed something
  </action>
  <verify>
Run `python -c "from hivemind.cli import app; print('CLI app importable')"`.
Run `python -c "from hivemind.cli.review import review; print('review command importable')"`.
Run `python -c "from hivemind.cli.client import fetch_pending, approve_contribution, reject_contribution, flag_contribution; print('CLI client OK')"`.
Verify the CLI entry point works: `python -m hivemind.cli --help` shows the review command.
  </verify>
  <done>CLI review command implemented with Typer + Rich + questionary. Shows clean PII-stripped content in Rich Panels. Supports: approve (private/public), category override, flag as sensitive, reject, skip. Gamification messages on approval showing contribution count and agent reach. Session summary at end. Sync DB client uses FOR UPDATE SKIP LOCKED for safe concurrent access. Embedding generated at approval time.</done>
</task>

</tasks>

<verification>
1. All 4 MCP tools registered on the FastMCP server: add_knowledge, search_knowledge, list_knowledge, delete_knowledge
2. list_knowledge filters by source_agent_id from auth — agents see only their own
3. delete_knowledge uses soft-delete (deleted_at timestamp), scoped by org_id + agent_id
4. delete_knowledge returns 404 (not 403) for non-owned items
5. search_knowledge excludes soft-deleted items (WHERE deleted_at IS NULL)
6. CLI review command shows pending contributions with Rich formatting
7. CLI supports: approve private, approve public, category override, flag, reject, skip
8. Embeddings generated at approval time (not at contribution time)
9. Gamification messages display after each approval
10. CLI uses sync DB connection (no asyncio issues)
11. FOR UPDATE SKIP LOCKED used for pending queue access
</verification>

<success_criteria>
- Phase 1 success criteria 2 satisfied: user reviews pending, sees PII stripped, approves or rejects, approved enters commons
- Phase 1 success criteria 4 satisfied: agent can list and delete their contributions
- `hivemind review --help` shows the command with --org-id option
- All 4 tools callable on the MCP server
- Soft-delete with deleted_at column and migration in place
</success_criteria>

<output>
After completion, create `.planning/phases/01-agent-connection-loop/01-04-SUMMARY.md`
</output>
