---
phase: 01-agent-connection-loop
plan: 01
subsystem: database
tags: [sqlalchemy, asyncpg, pgvector, alembic, pydantic-settings, postgresql, python]

# Dependency graph
requires: []
provides:
  - SQLAlchemy async engine and session factory (AsyncSessionFactory, get_session)
  - ORM models: PendingContribution, KnowledgeItem, DeploymentConfig, KnowledgeCategory
  - Pydantic BaseSettings configuration with HIVEMIND_ env prefix
  - Alembic migration creating pgvector extension, all tables, HNSW index, unique constraints
  - pyproject.toml with all Phase 1 dependencies
affects:
  - 01-02 (PII pipeline — imports models and session factory)
  - 01-03 (MCP server — imports models, session, config)
  - 01-04 (CLI review — imports models and session factory)

# Tech tracking
tech-stack:
  added:
    - sqlalchemy[asyncio]>=2.0 (async ORM)
    - asyncpg>=0.30.0 (async PostgreSQL driver; pinned >=0.30.0 for Python 3.14 compat)
    - pgvector (VECTOR column type + HNSW index support)
    - alembic (database migrations with pgvector type registration)
    - pydantic>=2.0 (validation)
    - pydantic-settings (HIVEMIND_-prefixed environment settings)
    - fastmcp<3, fastapi, uvicorn (declared in pyproject.toml; used in later plans)
    - presidio-analyzer[gliner], presidio-anonymizer, gliner (declared; used in 01-02)
    - sentence-transformers (declared; used in 01-03)
    - typer, rich, questionary (declared; used in 01-04)
    - celery, redis (declared; used in later plans)
    - spacy, python-jose, httpx (declared supporting libraries)
  patterns:
    - Module-level settings singleton (hivemind.config.settings) imported throughout
    - Per-request async session via asynccontextmanager get_session()
    - DeclarativeBase ORM with Mapped[] type annotations
    - Manual Alembic migration (not autogenerated) for clarity on complex DDL

key-files:
  created:
    - pyproject.toml
    - hivemind/__init__.py
    - hivemind/config.py
    - hivemind/db/__init__.py
    - hivemind/db/models.py
    - hivemind/db/session.py
    - alembic.ini
    - alembic/env.py
    - alembic/versions/001_initial_schema.py
  modified: []

key-decisions:
  - "asyncpg pin changed from <0.29.0 to >=0.30.0 — research pin was for Python 3.11; Python 3.14 requires newer C extension build"
  - "Unique constraint on (content_hash, org_id) not just content_hash — two orgs can contribute identical knowledge without conflict"
  - "HNSW index created at migration time with m=16, ef_construction=64 before any data arrives"
  - "Manual migration file (not autogenerated) for clarity and explicit pgvector DDL control"
  - "asynccontextmanager get_session() pattern ensures per-request sessions; AsyncSession is not concurrency-safe"

patterns-established:
  - "Settings singleton: from hivemind.config import settings — used everywhere, not re-instantiated"
  - "Session pattern: async with get_session() as session — never share sessions across concurrent requests"
  - "All tables carry org_id for namespace isolation (ACL-01 pattern)"
  - "Provenance fields (source_agent_id, contributed_at, content_hash) set on INSERT, never updated"

requirements-completed: [INFRA-01, INFRA-05, KM-01, KM-04, ACL-01]

# Metrics
duration: 5min
completed: 2026-02-18
---

# Phase 1 Plan 01: Project Scaffolding, DB Models, and Migrations Summary

**PostgreSQL async foundation with SQLAlchemy 2 ORM models (PendingContribution, KnowledgeItem, DeploymentConfig), pgvector HNSW index, and Alembic migration — all Phase 1 dependencies declared in pyproject.toml**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-18T20:59:20Z
- **Completed:** 2026-02-18T21:04:30Z
- **Tasks:** 2
- **Files modified:** 9

## Accomplishments

- `pyproject.toml` with all Phase 1 dependencies declared: fastmcp, sqlalchemy[asyncio], asyncpg, pgvector, alembic, presidio, sentence-transformers, typer, celery, redis
- `hivemind/config.py`: Pydantic BaseSettings with HIVEMIND_ env prefix, 7 settings fields, module-level singleton
- `hivemind/db/models.py`: KnowledgeCategory enum (11 values), PendingContribution (14 columns), KnowledgeItem (16 columns + HNSW index + unique constraint), DeploymentConfig — all with immutable provenance fields and org_id isolation
- `hivemind/db/session.py`: async engine with pool_size=10/max_overflow=20, async_sessionmaker, asynccontextmanager get_session()
- `alembic/env.py`: async migration runner with pgvector register_vector() and Base.metadata wiring
- `alembic/versions/001_initial_schema.py`: full manual migration creating pgvector extension, knowledgecategory enum, 3 tables, HNSW index, unique(content_hash, org_id) constraint, 4 indexes

## Task Commits

Each task was committed atomically:

1. **Task 1: Project scaffolding + config + DB models** - `a190bdd` (feat)
2. **Task 2: Alembic migrations with pgvector support** - `72be746` (feat)

## Files Created/Modified

- `pyproject.toml` - Project metadata, all Phase 1 dependencies, CLI entry point, hatchling build system
- `hivemind/__init__.py` - Package marker with version
- `hivemind/config.py` - Settings class with Pydantic BaseSettings, HIVEMIND_ prefix, module-level singleton
- `hivemind/db/__init__.py` - Database package marker
- `hivemind/db/models.py` - KnowledgeCategory enum, Base, PendingContribution, KnowledgeItem, DeploymentConfig ORM models
- `hivemind/db/session.py` - Async engine, AsyncSessionFactory, get_session() context manager
- `alembic.ini` - Alembic config with default DB URL (overridden at runtime from settings)
- `alembic/env.py` - Async migration env with pgvector register_vector() and settings URL override
- `alembic/versions/001_initial_schema.py` - Complete initial schema migration

## Decisions Made

- Used >=0.30.0 for asyncpg instead of the researched <0.29.0 pin — Python 3.14 cannot build the older C extension
- Unique constraint is (content_hash, org_id) not just content_hash — two orgs can contribute identical knowledge without a UniqueViolation
- HNSW index parameters: m=16, ef_construction=64 (pgvector recommended defaults for balanced recall/performance)
- Manual migration file instead of autogenerated for explicit control over pgvector DDL (CREATE EXTENSION, VECTOR type)
- DeploymentConfig table stores embedding model name + revision hash at first startup (KM-08 provenance)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] asyncpg version pin incompatible with Python 3.14**
- **Found during:** Task 1 (dependency installation)
- **Issue:** Research specified `asyncpg<0.29.0` for Python 3.11 SQLAlchemy compatibility. On Python 3.14, asyncpg<0.29.0 fails to build its C extension due to changed `_PyLong_AsByteArray` function signature (requires 6 args, old code passes 5).
- **Fix:** Changed pin from `asyncpg<0.29.0` to `asyncpg>=0.30.0` in pyproject.toml. asyncpg 0.31.0 installed successfully with a pre-built wheel for Python 3.14.
- **Files modified:** `pyproject.toml`
- **Verification:** `asyncpg 0.31.0` installed; `from hivemind.db.session import engine, get_session` imports successfully
- **Committed in:** `a190bdd` (Task 1 commit)

---

**Total deviations:** 1 auto-fixed (1 Rule 1 bug fix)
**Impact on plan:** Required for the project to install on Python 3.14. asyncpg 0.31.0 is fully compatible with SQLAlchemy 2.x. No scope creep.

## Issues Encountered

None beyond the asyncpg version deviation documented above.

## User Setup Required

None — no external service configuration required for this plan. Running migrations requires a PostgreSQL instance with pgvector extension installed, which is a prerequisite documented in the project README (to be created).

## Next Phase Readiness

- DB models are importable and complete — plan 01-02 (PII pipeline) can import `from hivemind.db.models import *`
- Session factory ready for plan 01-03 (MCP server) and 01-04 (CLI review)
- Migration ready to run: `alembic upgrade head` (requires PostgreSQL + pgvector running)
- Python virtual environment at `.venv/` with dependencies installed; subsequent plans use same venv

---
*Phase: 01-agent-connection-loop*
*Completed: 2026-02-18*
