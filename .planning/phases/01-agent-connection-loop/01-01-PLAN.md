---
phase: 01-agent-connection-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - hivemind/__init__.py
  - hivemind/config.py
  - hivemind/db/__init__.py
  - hivemind/db/models.py
  - hivemind/db/session.py
  - alembic.ini
  - alembic/env.py
  - alembic/versions/001_initial_schema.py
autonomous: true
requirements:
  - INFRA-01
  - INFRA-05
  - KM-01
  - KM-04
  - ACL-01

must_haves:
  truths:
    - "PostgreSQL tables exist for pending_contributions and knowledge_items with all required columns"
    - "Every knowledge item has immutable provenance fields (source_agent_id, contributed_at, category, org_id, confidence_score, run_id, content_hash)"
    - "Knowledge items are typed by category enum with framework/language/version metadata"
    - "All tables have org_id column for namespace isolation"
    - "Async database sessions can be created and used for concurrent operations"
    - "Alembic migration creates pgvector extension, all tables, and HNSW index"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata and all Phase 1 dependencies"
      contains: "fastmcp"
    - path: "hivemind/config.py"
      provides: "Centralized settings via Pydantic BaseSettings"
      contains: "class Settings"
    - path: "hivemind/db/models.py"
      provides: "SQLAlchemy ORM models for PendingContribution, KnowledgeItem, DeploymentConfig"
      exports: ["Base", "PendingContribution", "KnowledgeItem", "DeploymentConfig", "KnowledgeCategory"]
      min_lines: 80
    - path: "hivemind/db/session.py"
      provides: "Async engine and session factory"
      exports: ["engine", "AsyncSessionFactory", "get_session"]
      min_lines: 15
    - path: "alembic/env.py"
      provides: "Alembic migration env with pgvector type registration"
      contains: "register_vector"
  key_links:
    - from: "hivemind/db/session.py"
      to: "hivemind/config.py"
      via: "Settings.database_url"
      pattern: "Settings.*database_url"
    - from: "alembic/env.py"
      to: "hivemind/db/models.py"
      via: "target_metadata = Base.metadata"
      pattern: "Base\\.metadata"
---

<objective>
Set up the HiveMind Python project with all Phase 1 dependencies, database models, async session management, and Alembic migrations. This is the foundation everything else builds on.

Purpose: Every other plan depends on the DB models, session factory, and project configuration. Shipping this first unblocks parallel work on PII pipeline and MCP tools.
Output: A runnable Python project with `pyproject.toml`, SQLAlchemy models for `pending_contributions`, `knowledge_items`, and `deployment_config` tables, async session factory, and an Alembic migration that creates the full schema including pgvector HNSW index.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-agent-connection-loop/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding + config + DB models</name>
  <files>
    pyproject.toml
    hivemind/__init__.py
    hivemind/config.py
    hivemind/db/__init__.py
    hivemind/db/models.py
    hivemind/db/session.py
  </files>
  <action>
Create the project structure and all foundation files:

**pyproject.toml:**
- Project name: `hivemind`
- Python >= 3.11
- All Phase 1 dependencies (from research standard stack):
  - `"fastmcp<3"`, `fastapi`, `uvicorn`
  - `sqlalchemy[asyncio]>=2.0`, `"asyncpg<0.29.0"`, `pgvector`, `alembic`
  - `"presidio-analyzer[gliner]"`, `presidio-anonymizer`, `gliner`
  - `sentence-transformers`
  - `pydantic>=2.0`, `pydantic-settings`
  - `typer`, `rich`, `questionary`
  - `spacy`, `python-jose[cryptography]`, `httpx`
- Dev dependencies: `pytest`, `pytest-asyncio`, `pytest-cov`
- CLI entry point: `[project.scripts] hivemind = "hivemind.cli:app"`

**hivemind/config.py:**
- `class Settings(BaseSettings)` with:
  - `database_url: str` (default: `"postgresql+asyncpg://postgres:postgres@localhost:5432/hivemind"`)
  - `secret_key: str` (default: `"dev-secret-change-me"`)
  - `embedding_model: str` (default: `"sentence-transformers/all-MiniLM-L6-v2"`)
  - `embedding_dimensions: int` (default: `384`)
  - `pii_rejection_threshold: float` (default: `0.50`)
  - `default_search_limit: int` (default: `10`)
  - `max_search_limit: int` (default: `50`)
  - `model_config = SettingsConfigDict(env_prefix="HIVEMIND_", env_file=".env")`
- Module-level singleton: `settings = Settings()`

**hivemind/db/models.py:**
- `class KnowledgeCategory(str, enum.Enum)` with values: `bug_fix`, `config`, `domain_expertise`, `workaround`, `pricing_data`, `regulatory_rule`, `tooling`, `reasoning_trace`, `failed_approach`, `version_workaround`, `general`
- `class Base(DeclarativeBase): pass`

- `class PendingContribution(Base)`:
  - `__tablename__ = "pending_contributions"`
  - `id`: UUID primary key, default uuid4
  - `org_id`: String(255), not null, indexed
  - `source_agent_id`: String(255), not null
  - `run_id`: String(255), nullable
  - `content`: Text, not null (already PII-stripped per TRUST-01)
  - `content_hash`: String(64), not null (SHA-256 of stripped content)
  - `category`: Enum(KnowledgeCategory), not null
  - `confidence`: Float, default 0.8
  - `framework`: String(100), nullable
  - `language`: String(50), nullable
  - `version`: String(50), nullable
  - `tags`: JSONB, nullable
  - `contributed_at`: DateTime(timezone=True), not null, default utcnow
  - `is_sensitive_flagged`: Boolean, default False

- `class KnowledgeItem(Base)`:
  - `__tablename__ = "knowledge_items"`
  - `id`: UUID primary key, default uuid4
  - `org_id`: String(255), not null, indexed
  - `is_public`: Boolean, default False (private namespace by default per user decision)
  - `source_agent_id`: String(255), not null
  - `run_id`: String(255), nullable
  - `content`: Text, not null
  - `content_hash`: String(64), not null
  - `category`: Enum(KnowledgeCategory), not null
  - `confidence`: Float, default 0.8
  - `framework`: String(100), nullable
  - `language`: String(50), nullable
  - `version`: String(50), nullable
  - `tags`: JSONB, nullable
  - `embedding`: VECTOR(384), nullable
  - `contributed_at`: DateTime(timezone=True), not null (immutable provenance)
  - `approved_at`: DateTime(timezone=True), default utcnow
  - `__table_args__`: UniqueConstraint on `(content_hash, org_id)` for private items (per pitfall 4 in research), HNSW index on embedding with `vector_cosine_ops`, composite index on `(org_id, is_public)` for search filtering

- `class DeploymentConfig(Base)`:
  - `__tablename__ = "deployment_config"`
  - `key`: String(255), primary key
  - `value`: Text, not null
  - `created_at`: DateTime(timezone=True), default utcnow
  - `updated_at`: DateTime(timezone=True), default utcnow, onupdate utcnow

**hivemind/db/session.py:**
- Import settings from config
- `engine = create_async_engine(settings.database_url, echo=False, pool_size=10, max_overflow=20)`
- `AsyncSessionFactory = async_sessionmaker(engine, expire_on_commit=False)`
- `@asynccontextmanager async def get_session()` yielding AsyncSession
- Note in docstring: each request must get its own session (not shared across concurrent requests)
  </action>
  <verify>
Run `python -c "from hivemind.db.models import Base, PendingContribution, KnowledgeItem, DeploymentConfig, KnowledgeCategory; print('Models OK')"` — should print "Models OK".
Run `python -c "from hivemind.config import settings; print(settings.database_url)"` — should print the default database URL.
Run `python -c "from hivemind.db.session import engine, get_session; print('Session OK')"` — should print "Session OK".
  </verify>
  <done>All SQLAlchemy models importable with correct columns, types, indexes, and constraints. Settings loads from env with defaults. Session factory configured with async engine.</done>
</task>

<task type="auto">
  <name>Task 2: Alembic migrations with pgvector support</name>
  <files>
    alembic.ini
    alembic/env.py
    alembic/script.py.mako
    alembic/versions/001_initial_schema.py
  </files>
  <action>
Set up Alembic for async migrations with pgvector:

**alembic.ini:**
- Standard Alembic config
- `sqlalchemy.url` set to `postgresql+asyncpg://postgres:postgres@localhost:5432/hivemind` (overridden in env.py from Settings)
- `script_location = alembic`

**alembic/env.py:**
- Import `Base` from `hivemind.db.models`
- Set `target_metadata = Base.metadata`
- Register pgvector types: `from pgvector.sqlalchemy import Vector` and call registration
- Use async engine from settings for online migrations:
  - `run_async_migrations()` using `create_async_engine` with URL from `hivemind.config.settings`
  - `do_run_migrations(connection)` with `context.configure(connection=connection, target_metadata=target_metadata)`
- Support both offline (SQL generation) and online (direct DB) modes

**alembic/versions/001_initial_schema.py:**
- Create a manual migration (not autogenerated) for clarity
- `upgrade()`:
  1. Execute `CREATE EXTENSION IF NOT EXISTS vector` (pgvector extension)
  2. Create `deployment_config` table
  3. Create `pending_contributions` table with all columns, index on `org_id`
  4. Create `knowledge_items` table with all columns, VECTOR(384) column for embedding
  5. Create HNSW index: `CREATE INDEX ix_knowledge_items_embedding_hnsw ON knowledge_items USING hnsw (embedding vector_cosine_ops) WITH (m = 16, ef_construction = 64)`
  6. Create unique constraint: `(content_hash, org_id)` on knowledge_items
  7. Create composite index: `(org_id, is_public)` on knowledge_items
  8. Create index on `org_id` for pending_contributions
- `downgrade()`: Drop tables in reverse order, drop pgvector extension
- Use raw SQL via `op.execute()` for pgvector-specific DDL; use `op.create_table()` for standard tables
  </action>
  <verify>
Run `python -c "import alembic; print('Alembic importable')"` — confirms alembic is installed.
Verify migration file exists and contains `CREATE EXTENSION IF NOT EXISTS vector` and HNSW index creation.
Verify `alembic/env.py` references `Base.metadata` from models.
  </verify>
  <done>Alembic configured with async support. Initial migration creates pgvector extension, all three tables (deployment_config, pending_contributions, knowledge_items), HNSW index, and unique constraint on (content_hash, org_id). Migration is ready to run against a PostgreSQL instance with pgvector installed.</done>
</task>

</tasks>

<verification>
1. All model imports work without errors
2. KnowledgeCategory enum has all 11 values from KM-04
3. PendingContribution and KnowledgeItem have all provenance fields from KM-01
4. org_id is indexed on both tables (ACL-01 foundation)
5. HNSW index defined for vector similarity search
6. Unique constraint is (content_hash, org_id) not just content_hash (pitfall 4)
7. Settings loads from environment with sensible defaults
8. Async session factory creates per-request sessions
9. Alembic migration is complete and syntactically valid
</verification>

<success_criteria>
- `python -c "from hivemind.db.models import *"` succeeds
- `python -c "from hivemind.config import settings"` succeeds
- `python -c "from hivemind.db.session import get_session"` succeeds
- Migration file contains pgvector extension creation and HNSW index
- All 14 Phase 1 requirement IDs have supporting model fields where applicable
</success_criteria>

<output>
After completion, create `.planning/phases/01-agent-connection-loop/01-01-SUMMARY.md`
</output>
