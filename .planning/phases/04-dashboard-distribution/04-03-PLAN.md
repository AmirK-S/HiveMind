---
phase: 04-dashboard-distribution
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - dashboard/src/app/contributions/page.tsx
  - dashboard/src/app/contributions/[id]/page.tsx
  - dashboard/src/app/analytics/page.tsx
  - dashboard/src/app/api/contributions/route.ts
  - dashboard/src/app/api/contributions/[id]/approve/route.ts
  - dashboard/src/app/api/contributions/[id]/reject/route.ts
  - dashboard/src/app/api/stats/commons/route.ts
  - dashboard/src/app/api/stats/org/route.ts
  - dashboard/src/components/contributions/ReviewCard.tsx
  - dashboard/src/components/charts/GrowthChart.tsx
  - dashboard/src/components/charts/StatsCard.tsx
  - dashboard/src/app/api/knowledge/[id]/route.ts
autonomous: true
requirements:
  - DASH-03
  - DASH-04
  - DASH-05
  - DASH-06

must_haves:
  truths:
    - "User can see a list of pending contributions and approve or reject each one from the dashboard"
    - "User can view knowledge item detail with full provenance (source_agent_id, contributed_at, content_hash, org attribution)"
    - "User can see per-org contribution and retrieval statistics including reciprocity metrics"
    - "User can see commons health metrics: total items, growth rate, retrieval volume, domains covered"
  artifacts:
    - path: "dashboard/src/app/contributions/page.tsx"
      provides: "Pending contributions review list with approve/reject actions"
      min_lines: 40
    - path: "dashboard/src/app/contributions/[id]/page.tsx"
      provides: "Knowledge item detail page with full provenance"
      min_lines: 30
    - path: "dashboard/src/app/analytics/page.tsx"
      provides: "Analytics page with reciprocity ledger and commons health metrics"
      min_lines: 50
    - path: "dashboard/src/components/charts/GrowthChart.tsx"
      provides: "Recharts AreaChart for growth visualization"
      min_lines: 20
  key_links:
    - from: "dashboard/src/app/contributions/page.tsx"
      to: "hivemind/api/routes/contributions.py"
      via: "TanStack Query + proxy route handlers for list, approve, reject"
      pattern: "useMutation|approve|reject"
    - from: "dashboard/src/app/analytics/page.tsx"
      to: "hivemind/api/routes/stats.py"
      via: "TanStack Query polling for commons and org stats"
      pattern: "stats/commons|stats/org"
    - from: "dashboard/src/components/charts/GrowthChart.tsx"
      to: "recharts"
      via: "AreaChart import from recharts"
      pattern: "import.*AreaChart.*recharts"
---

<objective>
Implement the dashboard feature pages: contribution review workflow (approve/reject), knowledge item detail with provenance, and analytics dashboard with reciprocity ledger and commons health metrics.

Purpose: DASH-03/04/05/06 require the human to interact with contributions and view analytics. This plan delivers the management and observation layer that makes the commons tangible.
Output: Three feature pages (contributions, item detail, analytics) with full CRUD and visualization.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dashboard-distribution/04-RESEARCH.md
@.planning/phases/04-dashboard-distribution/04-01-SUMMARY.md
@.planning/phases/04-dashboard-distribution/04-02-SUMMARY.md
@dashboard/src/lib/api.ts
@dashboard/src/lib/query-client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Contributions review page with approve/reject workflow</name>
  <files>
    dashboard/src/app/contributions/page.tsx
    dashboard/src/app/api/contributions/route.ts
    dashboard/src/app/api/contributions/[id]/approve/route.ts
    dashboard/src/app/api/contributions/[id]/reject/route.ts
    dashboard/src/components/contributions/ReviewCard.tsx
  </files>
  <action>
**Proxy route handlers (three files):**

`dashboard/src/app/api/contributions/route.ts` — GET proxy:
- Forward to `${HIVEMIND_API_URL}/api/v1/contributions` with query params (limit, offset).
- Pass X-API-Key header.

`dashboard/src/app/api/contributions/[id]/approve/route.ts` — POST proxy:
- Forward to `${HIVEMIND_API_URL}/api/v1/contributions/${params.id}/approve`.
- Pass X-API-Key header.

`dashboard/src/app/api/contributions/[id]/reject/route.ts` — POST proxy:
- Forward to `${HIVEMIND_API_URL}/api/v1/contributions/${params.id}/reject`.
- Pass X-API-Key header.

**`dashboard/src/components/contributions/ReviewCard.tsx`** — `"use client"` review card:
- Displays: title, content preview (expandable to full), category badge, source_agent_id, submitted timestamp (relative), content_hash (truncated, copyable).
- Two action buttons: "Approve" (green) and "Reject" (red).
- Use TanStack Query `useMutation` for approve/reject actions.
- Optimistic update: immediately remove card from list on action, rollback on error.
- After mutation success: invalidate the `["contributions"]` query key to refresh the list.
- Loading state on buttons during mutation (spinner or disabled).
- Confirmation dialog for reject action (simple confirm() or a small inline "Are you sure?" toggle).

**`dashboard/src/app/contributions/page.tsx`** — `"use client"` contributions list:
- Page title: "Pending Contributions" with count badge.
- Use TanStack Query `useQuery` with `queryKey: ["contributions"]` to fetch pending list.
- Polling: `refetchInterval: 15_000` (15s) to pick up new contributions.
- Render list of `ReviewCard` components.
- Empty state: "No pending contributions — all caught up!" with a checkmark icon.
- Loading state: skeleton cards.
  </action>
  <verify>
`cd dashboard && npm run build` succeeds. `grep -r "useMutation" dashboard/src/components/contributions/ReviewCard.tsx` confirms mutation usage. Contributions page renders ReviewCard list.
  </verify>
  <done>Contributions page shows pending items with approve/reject buttons using optimistic updates via TanStack Query mutations, proxied through Next.js route handlers to FastAPI.</done>
</task>

<task type="auto">
  <name>Task 2: Knowledge item detail page with full provenance</name>
  <files>
    dashboard/src/app/contributions/[id]/page.tsx
  </files>
  <action>
**`dashboard/src/app/contributions/[id]/page.tsx`** — Item detail page:

This page serves double duty:
1. For **pending** contributions: shows full detail + approve/reject actions.
2. For **approved** knowledge items: shows full detail with provenance.

Implementation:
- Accept dynamic route param `[id]`.
- Create a Next.js route handler `dashboard/src/app/api/knowledge/[id]/route.ts` that proxies to `${HIVEMIND_API_URL}/api/v1/knowledge/${params.id}` (existing endpoint from Phase 3).
- Use TanStack Query to fetch the item by id.
- Display ALL provenance fields:
  - **Title** (large heading)
  - **Full content** (rendered as markdown if possible, or plain text in a pre block)
  - **Category** (colored badge)
  - **Source Agent ID** (monospace, labeled "Contributed by agent")
  - **Organization** (org_id, labeled "Organization")
  - **Contributed At** (full timestamp, formatted as locale date string)
  - **Content Hash** (SHA-256, monospace, full hash displayed, copyable)
  - **Quality Score** (0-1 as percentage bar, with color gradient: red < 0.3, yellow 0.3-0.6, green > 0.6)
  - **Retrieval Count** (how many times retrieved)
  - **Helpful / Not Helpful Counts** (with ratio display)
  - **Is Public** (badge: "Public" green or "Private" gray)
  - **Version info**: valid_at, expired_at if present

- Layout: Two-column on desktop (content left, metadata/provenance right), single column on mobile.
- Back link to contributions list or previous page.
- If the item is a pending contribution (has no quality_score), show approve/reject buttons.

Also create the knowledge detail proxy route handler at `dashboard/src/app/api/knowledge/[id]/route.ts`.
  </action>
  <verify>
`cd dashboard && npm run build` succeeds. Detail page file exists at `dashboard/src/app/contributions/[id]/page.tsx`. Provenance fields (content_hash, source_agent_id, quality_score) are all rendered.
  </verify>
  <done>Item detail page displays full content with all provenance metadata (agent, org, hash, quality, retrieval stats, temporal info) in a responsive two-column layout.</done>
</task>

<task type="auto">
  <name>Task 3: Analytics page with reciprocity ledger and commons health</name>
  <files>
    dashboard/src/app/analytics/page.tsx
    dashboard/src/app/api/stats/commons/route.ts
    dashboard/src/app/api/stats/org/route.ts
    dashboard/src/components/charts/GrowthChart.tsx
    dashboard/src/components/charts/StatsCard.tsx
  </files>
  <action>
**Proxy route handlers:**

`dashboard/src/app/api/stats/commons/route.ts` — GET proxy to `/api/v1/stats/commons`.
`dashboard/src/app/api/stats/org/route.ts` — GET proxy to `/api/v1/stats/org`.

**`dashboard/src/components/charts/StatsCard.tsx`** — Reusable stat card:
- Accepts: title, value (number or string), subtitle (optional), trend (optional: up/down/neutral).
- Displays as a card with large numeric value, title below, optional trend indicator.
- Tailwind styling: rounded, shadow, padding, responsive.

**`dashboard/src/components/charts/GrowthChart.tsx`** — `"use client"` growth chart:
- Uses Recharts `AreaChart` with `Area`, `XAxis`, `YAxis`, `Tooltip`, `ResponsiveContainer`.
- Accepts data prop as `{date: string, count: number}[]`.
- Gradient fill on the area (brand color, e.g., indigo/blue).
- Responsive: wraps in `ResponsiveContainer width="100%" height={300}`.

**`dashboard/src/app/analytics/page.tsx`** — `"use client"` analytics page:

Two sections:

**Section 1: Commons Health (DASH-06)** — "Public Commons Health" heading:
- Use TanStack Query to fetch `/api/stats/commons` with `refetchInterval: 30_000` (30s polling per research recommendation — not SSE for metrics).
- Display as grid of StatsCard components:
  - Total Knowledge Items
  - Growth (24h) — new items in last 24 hours
  - Growth (7d) — new items in last 7 days
  - Retrieval Volume (24h)
  - Domains Covered — count of distinct categories
  - Pending Contributions
- Below stats cards: category breakdown as a simple horizontal bar chart (Recharts BarChart) showing item count per category.
- All metrics demonstrate network effect — show the commons is growing.

**Section 2: Organization Reciprocity Ledger (DASH-03)** — "Your Organization" heading:
- Use TanStack Query to fetch `/api/stats/org` with `refetchInterval: 30_000`.
- Display as grid of StatsCard components:
  - Total Contributions (your org's items)
  - Retrieved by Others (reciprocity metric — how many times YOUR knowledge helped OTHER agents)
  - Helpful Ratio (helpful_count / total feedback)
  - Pending (awaiting review)
- "Top Items" section: table of top 5 items by retrieval_count (title, retrieval count, category).
- Reciprocity message: if retrievals_by_others > contributions_total, show "Your knowledge is in high demand!" — gamification element.

Layout: Full-width page, sections stacked vertically. Stats cards in a responsive grid (3 cols on lg, 2 on md, 1 on sm).
  </action>
  <verify>
`cd dashboard && npm run build` succeeds. `grep -r "AreaChart\|BarChart" dashboard/src/components/charts/` confirms Recharts usage. Analytics page imports both GrowthChart and StatsCard.
  </verify>
  <done>Analytics page displays commons health metrics (total items, growth, retrieval volume, domains) with 30s polling and org reciprocity ledger (contributions, retrievals by others, helpful ratio, top items) — all demonstrating network effect.</done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` — no build errors
2. Contributions page has approve/reject with optimistic updates
3. Item detail page shows all provenance fields (source_agent_id, content_hash, quality_score, contributed_at, org_id)
4. Analytics page has commons health section and org reciprocity section with Recharts charts
5. All API calls go through Next.js route handler proxies (no direct browser-to-FastAPI)
</verification>

<success_criteria>
- User can review pending contributions and approve/reject from the dashboard
- Item detail displays full provenance including content hash, agent, quality score, temporal info
- Analytics shows commons health metrics with 30s polling
- Analytics shows org reciprocity data with gamification elements
- All Recharts charts render correctly (AreaChart, BarChart)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-distribution/04-03-SUMMARY.md`
</output>
