---
phase: 04-dashboard-distribution
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - dashboard/package.json
  - dashboard/tsconfig.json
  - dashboard/tailwind.config.ts
  - dashboard/src/app/layout.tsx
  - dashboard/src/app/page.tsx
  - dashboard/src/app/commons/page.tsx
  - dashboard/src/app/dashboard/page.tsx
  - dashboard/src/app/search/page.tsx
  - dashboard/src/app/api/stream/feed/route.ts
  - dashboard/src/components/feed/LiveFeed.tsx
  - dashboard/src/components/feed/FeedItem.tsx
  - dashboard/src/lib/api.ts
  - dashboard/src/lib/query-client.ts
  - dashboard/src/components/layout/Sidebar.tsx
autonomous: true
requirements:
  - DASH-01
  - DASH-02

must_haves:
  truths:
    - "User can see the public commons feed updating in real time as new knowledge is approved"
    - "User can see their private namespace feed showing only their org's contributions"
    - "Public commons feed is the default and prominent view when opening the dashboard"
    - "User can search the knowledge commons from the dashboard and see ranked results"
  artifacts:
    - path: "dashboard/package.json"
      provides: "Next.js 15 project with all dependencies"
      contains: "next"
    - path: "dashboard/src/app/commons/page.tsx"
      provides: "Public commons live feed page (prominent/default view)"
      min_lines: 30
    - path: "dashboard/src/app/dashboard/page.tsx"
      provides: "Private namespace feed page"
      min_lines: 20
    - path: "dashboard/src/app/search/page.tsx"
      provides: "Knowledge search interface"
      min_lines: 30
    - path: "dashboard/src/components/feed/LiveFeed.tsx"
      provides: "SSE consumer component for real-time feed"
      min_lines: 30
  key_links:
    - from: "dashboard/src/components/feed/LiveFeed.tsx"
      to: "dashboard/src/app/api/stream/feed/route.ts"
      via: "EventSource connection to /api/stream/feed"
      pattern: "EventSource|useEventSource|/api/stream/feed"
    - from: "dashboard/src/app/api/stream/feed/route.ts"
      to: "hivemind/api/routes/stream.py"
      via: "fetch proxy to HIVEMIND_API_URL/api/v1/stream/feed"
      pattern: "HIVEMIND_API_URL.*stream/feed"
    - from: "dashboard/src/app/search/page.tsx"
      to: "hivemind/api/routes/knowledge.py"
      via: "TanStack Query calling /api/v1/knowledge/search"
      pattern: "knowledge/search"
---

<objective>
Scaffold the Next.js 15 dashboard application and implement the two live feed pages (public commons and private namespace) with real-time SSE consumption, plus the knowledge search interface.

Purpose: DASH-01 requires two feeds (public commons prominent, private namespace), and DASH-02 requires dashboard search. This plan delivers the core dashboard experience that demonstrates the network effect.
Output: A working Next.js 15 app at `dashboard/` with live commons feed, private feed, and search page.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dashboard-distribution/04-RESEARCH.md
@.planning/phases/04-dashboard-distribution/04-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Next.js 15 project scaffold with providers and layout</name>
  <files>
    dashboard/package.json
    dashboard/tsconfig.json
    dashboard/tailwind.config.ts
    dashboard/src/app/layout.tsx
    dashboard/src/app/page.tsx
    dashboard/src/lib/query-client.ts
    dashboard/src/lib/api.ts
    dashboard/src/components/layout/Sidebar.tsx
  </files>
  <action>
Create the `dashboard/` directory at repo root. Initialize with:

```bash
npx create-next-app@latest dashboard --typescript --tailwind --app --src-dir --no-import-alias
```

Then install additional dependencies:
```bash
cd dashboard && npm install @tanstack/react-query recharts
```

Note: Do NOT install react-use-websocket. Use the native browser `EventSource` API instead (simpler, no dependency, fully typed with a custom hook).

Create the following files:

**`dashboard/src/lib/query-client.ts`** — TanStack Query client singleton:
- Export a `QueryClient` instance with default options: `staleTime: 30_000` (30s), `refetchInterval: 30_000` for polling-based data.

**`dashboard/src/lib/api.ts`** — Typed fetch wrapper:
- Export helper functions: `apiFetch<T>(path: string, options?)` that calls Next.js route handlers (relative URLs like `/api/...`).
- Include typed response interfaces: `KnowledgeSearchResult`, `FeedEvent`, `StatsResponse`, `ContributionItem`.
- All fetch calls include `X-API-Key` header read from a cookie or passed via props (for now, use `process.env.NEXT_PUBLIC_HIVEMIND_API_KEY` for client-side calls — production would use server-side session).

**`dashboard/src/app/layout.tsx`** — Root layout:
- Wrap children in a `QueryClientProvider` (use a `"use client"` Providers component).
- Add a sidebar navigation with links: Commons (prominent, first), My Namespace, Search, Contributions, Analytics.
- Use Tailwind for styling: sidebar on left (w-64), main content area with `flex-1`.
- Import and apply a clean sans-serif font (Inter from next/font/google).

**`dashboard/src/components/layout/Sidebar.tsx`** — `"use client"` sidebar:
- Navigation links with active state detection via `usePathname()`.
- Links: `/commons` (with a globe icon label), `/dashboard` (namespace), `/search`, `/contributions`, `/analytics`.
- Commons link should be visually prominent (highlighted background or badge).

**`dashboard/src/app/page.tsx`** — Root redirect:
- Redirect to `/commons` (the prominent public view per DASH-01).
- Use `redirect("/commons")` from `next/navigation`.

Add `.env.local.example` with:
```
HIVEMIND_API_URL=http://localhost:8000
HIVEMIND_API_KEY=your-api-key-here
```
  </action>
  <verify>
`cd dashboard && npm run build` succeeds without errors. `ls dashboard/src/app/layout.tsx dashboard/src/lib/api.ts dashboard/src/lib/query-client.ts` all exist.
  </verify>
  <done>Next.js 15 app scaffolded at dashboard/ with TanStack Query provider, typed API client, sidebar navigation, and root redirect to /commons.</done>
</task>

<task type="auto">
  <name>Task 2: Live feed pages (commons + private) with SSE proxy</name>
  <files>
    dashboard/src/app/commons/page.tsx
    dashboard/src/app/dashboard/page.tsx
    dashboard/src/app/api/stream/feed/route.ts
    dashboard/src/components/feed/LiveFeed.tsx
    dashboard/src/components/feed/FeedItem.tsx
  </files>
  <action>
**`dashboard/src/app/api/stream/feed/route.ts`** — SSE proxy route handler:
- `export const runtime = 'nodejs'` (REQUIRED for SSE — Edge runtime cannot stream, Pitfall 6 from research).
- GET handler that proxies to `${process.env.HIVEMIND_API_URL}/api/v1/stream/feed`.
- Pass `X-API-Key` header from request headers or `process.env.HIVEMIND_API_KEY`.
- Return a `Response` with `ReadableStream` that pipes the upstream SSE body.
- Set headers: `Content-Type: text/event-stream`, `Cache-Control: no-cache, no-transform`, `Connection: keep-alive`, `X-Accel-Buffering: no` (prevent nginx buffering).

**`dashboard/src/components/feed/LiveFeed.tsx`** — `"use client"` SSE consumer:
- Uses native `EventSource` API (not a library) to connect to `/api/stream/feed`.
- Listens for named events: `"public"` and `"private"` (matching server-side event names).
- Maintains a state array of feed items, capped at 100 (newest first).
- Accepts a `type` prop: `"public" | "private"` — only processes events matching the type.
- Handles reconnection gracefully (EventSource auto-reconnects by spec).
- Shows a "Connected" / "Connecting..." status indicator.
- On error: set status to "Reconnecting..." and let EventSource retry.
- Clean up EventSource on unmount via useEffect cleanup.

**`dashboard/src/components/feed/FeedItem.tsx`** — Single feed item card:
- Displays: category badge (colored by category), title, org attribution (for public), timestamp (relative, e.g., "2m ago").
- Tailwind card styling: rounded border, shadow-sm, padding, hover state.
- Link to item detail page (`/contributions/{id}` or a future detail route).

**`dashboard/src/app/commons/page.tsx`** — Public commons page:
- Page title: "Knowledge Commons" with a subtitle like "See the collective knowledge growing in real time".
- Render `<LiveFeed type="public" />`.
- This is the PROMINENT view — larger text, prominent placement, demonstrates network effect.
- Below the live feed: placeholder for commons health metrics (will be implemented in Plan 04-03).

**`dashboard/src/app/dashboard/page.tsx`** — Private namespace page:
- Page title: "My Namespace" with a subtitle about the org's private contributions.
- Render `<LiveFeed type="private" />`.
- Simpler layout — this is the org-internal view.

Use Tailwind utility classes throughout. Cards, badges, and layout primitives only — no shadcn/ui components needed yet (Task 1 initialized Tailwind natively via create-next-app).
  </action>
  <verify>
`cd dashboard && npm run build` succeeds. `grep -r "EventSource" dashboard/src/components/feed/LiveFeed.tsx` shows EventSource usage. Both commons and dashboard pages import LiveFeed.
  </verify>
  <done>Commons page shows public live feed (prominent, default view), dashboard page shows private namespace feed, both consuming SSE via Next.js route handler proxy with EventSource.</done>
</task>

<task type="auto">
  <name>Task 3: Knowledge search page with TanStack Query</name>
  <files>
    dashboard/src/app/search/page.tsx
    dashboard/src/app/api/search/route.ts
  </files>
  <action>
**`dashboard/src/app/api/search/route.ts`** — Search proxy route handler:
- GET handler that proxies to `${process.env.HIVEMIND_API_URL}/api/v1/knowledge/search`.
- Forward query parameters: `query`, `limit`, `category`.
- Pass `X-API-Key` header.
- Return JSON response.
- Set explicit `operation_id` comment for documentation.

**`dashboard/src/app/search/page.tsx`** — `"use client"` search interface:
- Search input with debounce (300ms) — use a simple useState + useEffect with setTimeout pattern (no lodash needed).
- Category filter dropdown (optional) with values from KnowledgeCategory enum: bug_fix, workaround, configuration, domain_expertise, tooling, architecture, other.
- Results limit selector (10, 25, 50).
- Use TanStack Query `useQuery` with `queryKey: ["search", query, category, limit]` and `enabled: query.length >= 2` (don't search on empty/single-char input).
- Display results as cards: title, category badge, confidence score (as percentage), summary/content preview (truncated to 200 chars).
- Empty state: "Search the knowledge commons — type a query to find what agents have learned."
- Loading state: skeleton cards or spinner.
- No results state: "No knowledge found matching your query."
- Each result card links to the item detail page (future, for now just displays inline).

Use the `apiFetch` helper from `dashboard/src/lib/api.ts` for the fetch call. The search endpoint is the existing `GET /api/v1/knowledge/search` — no new backend work needed (DASH-02 confirmed in research).
  </action>
  <verify>
`cd dashboard && npm run build` succeeds. `grep -r "useQuery" dashboard/src/app/search/page.tsx` confirms TanStack Query usage. Search page renders with input, category filter, and results area.
  </verify>
  <done>Search page provides debounced search input, category filter, results display with confidence scores, and proper empty/loading/no-results states — all powered by the existing search API via TanStack Query.</done>
</task>

</tasks>

<verification>
1. `cd dashboard && npm run build` — no build errors
2. `ls dashboard/src/app/commons/page.tsx dashboard/src/app/dashboard/page.tsx dashboard/src/app/search/page.tsx` — all exist
3. Root `/` redirects to `/commons`
4. LiveFeed component uses native EventSource API with cleanup on unmount
5. Search page uses TanStack Query with debounced input
</verification>

<success_criteria>
- Next.js 15 app at dashboard/ builds without errors
- Commons page is the default/prominent view showing public live feed via SSE
- Dashboard page shows private namespace feed via SSE
- Search page queries existing /api/v1/knowledge/search with debounce, category filter, and results display
- SSE proxy route handler streams with correct headers (no-cache, no-transform, X-Accel-Buffering: no)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-distribution/04-02-SUMMARY.md`
</output>
